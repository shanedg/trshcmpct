<!DOCTYPE html>
<html>
<head>
  <title>My Discord OAuth2 App</title>
</head>
<body>

  {{#if username}}
  <div id="info">
    Hoi, {{username}}#{{discriminator}}!
    <img src="https://cdn.discordapp.com/avatars/{{id}}/{{avatar}}.webp?size=128" />
  </div>
  {{/if}}

  {{#unless username}}
  <!-- https://discordjs.guide/oauth2/#authorization-code-grant-flow -->
  <a
    id="login"
    style="display: none;"
    href="https://discord.com/api/oauth2/authorize?client_id={{clientId}}&redirect_uri=http%3A%2F%2Flocalhost%3A53134&response_type=code&scope=identify%20guilds"
  >
    Identify Yourself
  </a>
  {{/unless}}

  <script>
    function generateRandomString() {
      let randomString = '';
      const randomNumber = Math.floor(Math.random() * 10);

      for (let i = 0; i < 20 + randomNumber; i++) {
        randomString += String.fromCharCode(33 + Math.floor(Math.random() * 94));
      }

      return randomString;
    }

    window.onload = () => {
      const loginElement = document.getElementById('login');
      if (loginElement) {
        const randomString = generateRandomString();
        localStorage.setItem('oauth-state', randomString);
        loginElement.href += `&state=${btoa(randomString)}`;
        return loginElement.style.display = 'block';
      }

      const fragment = new URLSearchParams(window.location.search.slice(1));
      const state = fragment.get('state');
      if (localStorage.getItem('oauth-state') !== atob(decodeURIComponent(state))) {
        return console.log('You may have been clickjacked!');
      }
    };
  </script>
</body>
</html>
