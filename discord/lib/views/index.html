<!DOCTYPE html>
<html>

<head>
  <title>login</title>
  <style>
    body {
      background: black;
      color: white;
    }
  </style>
</head>

<body>
  <article>
    <h1>login</h1>
    <!-- https://discordjs.guide/oauth2/#authorization-code-grant-flow -->
    <!-- TODO: `redirect_uri` should come from request headers or something -->
    <a
      href="https://discord.com/api/oauth2/authorize?client_id={{clientId}}&redirect_uri=http%3A%2F%2Flocalhost%3A53134&response_type=code&scope=identify%20guilds"
      id="login"
      style="display: none;"
    >sign in with discord</a>
  </article>

  <script>
    // TODO: should this string come from the server on the initial request?
    // is that weird?
    function generateRandomString() {
      let randomString = '';
      const randomNumber = Math.floor(Math.random() * 10);

      for (let i = 0; i < 20 + randomNumber; i++) {
        randomString += String.fromCharCode(33 + Math.floor(Math.random() * 94));
      }

      return randomString;
    }

    window.onload = () => {
      window.history.replaceState(null, null, '/');
      const randomString = generateRandomString();
      localStorage.setItem('oauth-state', randomString);

      const loginElement = document.getElementById('login');
      loginElement.href += `&state=${btoa(randomString)}`;
      return loginElement.style.display = 'block';
    };
  </script>
</body>

</html>
