name: default

kind: pipeline
type: docker

steps:
- name: install
  image: node:gallium
  commands:
    - node common/scripts/install-run-rush.js install

- name: lint
  image: node:gallium
  commands:
    - node common/scripts/install-run-rush.js lint
  depends_on:
    - install

- name: type-check
  image: node:gallium
  commands:
    - node common/scripts/install-run-rush.js type-check
  depends_on:
    - install

- name: test
  image: node:gallium
  commands:
    - node common/scripts/install-run-rush.js test
  depends_on:
    - install

- name: build
  image: node:gallium
  commands:
    - node common/scripts/install-run-rush.js build
  depends_on:
    - install

# TODO: can't push version and changelog back to the mainline branch, see this error:
# `fatal: could not read Username for 'https://github.com': terminal prompts disabled`
# Solutions:
# * https://docs.drone.io/pipeline/docker/syntax/cloning/auth/#machine-accounts
# * https://docs.github.com/en/developers/overview/managing-deploy-keys#machine-users

# - name: version
#   image: node:gallium
#   commands:
#     - npx standard-version
#     - git push --follow-tags origin main
#   when:
#     branch:
#       include:
#         - main

- name: notify
  image: plugins/slack
  settings:
    webhook:
      from_secret: slack_webhook
    channel:
      from_secret: slack_channel
  when:
    status:
    - failure
    - success
  depends_on:
    - install
    - lint
    - type-check
    - test
    - build
